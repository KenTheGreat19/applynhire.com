<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employer Dashboard - APPLY N HIRE</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" href="vendor/images/logo.png" type="image/png">
    <link rel="icon" href="vendor/images/logo.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="site-header">
        <div class="container header-row">
            <div class="brand">
                <a class="site-logo" href="index.html"><img class="site-logo-img" src="vendor/images/logo.png" onerror="this.onerror=null;this.src='vendor/images/logo.svg'" alt="APPLY N HIRE"> APPLY N HIRE</a>
                <p class="tagline">Manage job postings and applicants</p>
            </div>
            <div class="right-nav"><nav class="auth-nav"></nav></div>
        </div>
    </header>

    <main class="container profile-page">
        <div class="profile-card">
            <h2 id="welcome">Hello, Employer</h2>
            <p id="email"></p>
            <p id="role"></p>
            <p>Post jobs, view applicants, and manage listings from here.</p>
            <button id="signOutBtn" class="secondary-btn">Sign Out</button>
        </div>

        <section class="container job-posting">
            <h3>Post a Job</h3>
            <form id="jobPostForm" class="auth-form">
                <label>Title</label>
                <input id="jobTitle" required>
                <label>Company</label>
                <input id="jobCompany" value="" required>
                <label>Location</label>
                <input id="jobLocation" value="Remote">
                <label>Type</label>
                <select id="jobType">
                    <option value="full-time">Full Time</option>
                    <option value="part-time">Part Time</option>
                    <option value="contract">Contract</option>
                </select>
                <label>Category</label>
                <input id="jobCategory" value="technology">
                <label>Salary</label>
                <input id="jobSalary">
                <label>Description</label>
                <textarea id="jobDescription"></textarea>
                <label>Tags (comma-separated)</label>
                <input id="jobTags">
                <button type="submit" class="primary-btn">Post Job</button>
            </form>
        </section>

        <section class="container employer-jobs">
            <h3>Your Jobs</h3>
            <div id="employerJobsList"></div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 APPLY N HIRE. | applynhire.com</p>
        </div>
    </footer>

    <script src="js/siteAuth.js"></script>
    <script src="js/auth-common.js"></script>
    <script src="js/header.js"></script>
    <script>
        // Basic session check
        function getSession() {
            const raw = localStorage.getItem('applynhireSession');
            return raw ? JSON.parse(raw) : null;
        }

        const session = getSession();
        if (!session || session.role !== 'employer') {
            alert('You are not signed in as an employer. Redirecting to Employer Sign In.');
            location.href = 'employer-signin.html';
        } else {
            document.getElementById('welcome').textContent = `Hello, ${session.name || 'Employer'}`;
            document.getElementById('email').textContent = session.email;
            document.getElementById('role').textContent = `Role: ${session.role}`;
        }

        document.getElementById('signOutBtn').addEventListener('click', () => {
            localStorage.removeItem('applynhireSession');
            location.href = 'employer-signin.html';
        });

        // Employer job posting and list
        async function loadEmployerJobs() {
            const token = (window.authCommon && authCommon.getToken) ? authCommon.getToken() : (session && session.token);
            const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
            try {
                const resp = await fetch('http://127.0.0.1:8000/api/employer/jobs', { headers });
                if (resp.ok) {
                    const data = await resp.json();
                    const list = document.getElementById('employerJobsList');
                    list.innerHTML = '';
                    data.forEach(job => {
                        const el = document.createElement('div');
                        el.className = 'job-card';
                        el.innerHTML = `<strong>${job.title}</strong> at ${job.company} - <em>${job.location}</em>`;
                        list.appendChild(el);
                    });
                }
            } catch (e) {
                console.error('Failed to load employer jobs', e);
            }
        }

        document.getElementById('jobPostForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('jobTitle').value;
            const company = document.getElementById('jobCompany').value;
            const location = document.getElementById('jobLocation').value;
            const type = document.getElementById('jobType').value;
            const category = document.getElementById('jobCategory').value;
            const salary = document.getElementById('jobSalary').value;
            const description = document.getElementById('jobDescription').value;
            const tags = (document.getElementById('jobTags').value || '').split(',').map(t => t.trim()).filter(Boolean);
            const token = (window.authCommon && authCommon.getToken) ? authCommon.getToken() : (session && session.token);
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            try {
                const resp = await fetch('http://127.0.0.1:8000/api/jobs', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ title, company, location, type, category, salary, description, tags })
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({ detail: 'Failed to create job' }));
                    alert('Failed to create job: ' + (err.detail || 'Unknown error'));
                    return;
                }
                const newJob = await resp.json();
                alert('Job posted successfully.');
                document.getElementById('jobPostForm').reset();
                loadEmployerJobs();
            } catch (e) {
                console.error('Job create error', e);
                alert('Could not reach backend to create job');
            }
        });

        // Load jobs initially
        loadEmployerJobs();
    </script>
</body>
</html>
